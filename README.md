<p align="center">
  <img width="150" height="150" src="https://github.com/gtsema/Mistension/blob/master/img/128.png">
</p>

<h1 align="center">
  Mistension
</h1>

Расширение Mistension для браузера Chrome позволяет вставлять в карточку бага в youtrack версию выбранного сервиса

## Установка:
* Т.к. необходимости в публикации расширения в chrome-store нет - расширение можно установить только используя режим разработчика. Для чего:
1. Скачать архив с расширением и разархивировать его
2. Перейти по пути `Настройки и управление Google Chrome -> Расширения -> Управление расширениями`
3. В правом верхнем углу включить режим разработчика
4. В левом верхнем углу нажать на кнопку `Загрузить распакованное расширение` и выбрать папку с расширением
4. Расширение установлено

## Работа с расширением:
* Для корректной работы расширения Mistension необходимо перезагрузить открытые страницы youtrack и/или mis после его установки
* Значек расширения - рыжий кот сидящий в спасательном круге

## Вставка версии микросервиса

### Выбор фичазоны:
1. Кликнуть ЛКМ по значку расширения на панели расширений
2. Выбрать необходимую фичазону

### Выбор сервисов:
1. Кликнуть ПКМ по значку расширения на панели расширений и выбрать пункт `Параметры`
2. На вкладке `Settings` с помощью чекбоксов выбрать сервисы, которые необходимо добавить в контектное меню

### Вставка версии:
* Вставка версии выбранного сервиса возможна только на странице карточки youtrack
* При попытке вставки версии выбранного сервиса на странице отличной от страницы youtrack - вставка совершена не будет
* При попытке вставки версии выбранного сервиса на странице youtrack не в тело карточки - вставка совершена не будет. Будет показано оповещение о невозможности вставки в этот элемент

1. Для вставки версии сервиса необходимо либо выбрать текст который необходимо заменить, либо установить курсор на место предполагаемой вставки версии сервиса и выполнить клик ПКМ
2. В открывшемся контекстном меню выбрать пункт `Mistension` и подпункт с названием сервиса, чью версию необходимо вставить
3. Вставка выполнена

## Автозаполнение полей mis

### Режим автозаполнения:
Сам режим автозаполнения можно включить нажав Ctrl+Shift+F или другую комбинацию, настроенную в `Управление расширениями - Быстрые клавиши - Mistension - Автозаполнение`
При активном режиме автозаполнения курсор меняет свой вид на волшебную палочку и если кликнуть на элемент, xpath которого был указан в локаторах, то он будет заполнен соответствующим значением.
Если нажать hotkeys ещё раз, то курсор вернёт свой первоначальный вид и функция не будет работать.

### Импорт локаторов:
После установки расширения, оно не содержит локаторов для заполнения полей. В папке с расширением находится файл `mistension_locators.json`, который содержит набор локаторов.
Чтобы его импортиорвать необходимо:
1. Перейти в настройки расширения на вкладку 'Автозаполнение'
2. Нажать кнопку 'Импорт' и выбрать файл `mistension_locators.json`

### Экспорт локаторов:
Для сохранения набора локаторов можно их экспортировать в файл. Для этого нужно нажать кнопку 'Экспорт' в настройках расширения и файл будет загружен.

### Добавление локаторов:
Для ручного добавления локаторов необходимо нажать кнопку 'Добавить' в настройках расширения и в появившейся форме ввести:
1. name - Название локатора
2. xpath - xpath элемента однозначно определяющий его на странице
3. value - значение или шаблон для заполнения

### Шаблоны:
Поле value может содержать два вида значений:
1. Строка
2. Шаблон для автогенерации значения

* В случае со строкой всё просто - то что ввели, то и будет вставлено в форму. Есть только ограничение на количество символов - не более 64х
* В случае с шаблоном: шаблон представляет собой набор символов, который будет заменён на сгенерированные.
* Указать тип символа:
  * %d - цифра
  * %s - буква
  * %m - цифра или буква
* Указать количество символов:
  * цифра следующая за типом символа: %d2 - две цифры, %s5 - пять букв
  * Результирующая строка также будет обрезана до 64х символов

  Основные проблемы могут быть с датами, т.к. исключать какие-то символы пока нельзя. Т.е. например дату в формате 12.01.1999 можно заменить шаблоном `1%d1.0%d1.19%d2`
  и тогда иногда мы сможем получать дату с месяцем '00' и её нужно будет ещё раз сгенерировать.

  Также нужно помнить, что сгенерированное значение вставляется в значение value выбранного input'a. Это значит, что нужно знать формат в котором input это значение содержит.
  Если есть сомнения в формате, то можно заполнить руками с ui значение и в консольке выполнить `document.evaluate('XPATH', document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue.value;`
  В данном выражении нужно заменить первый аргумент на xpath исследуемого элемента input. Выражение выведет в консоль значение в формате с нужным форматом.

### Как это работает:
Для общего понимания работает это так: Когда вы импортируете локаторы, то они хранятся в бд браузера. В момент клика на элементе скрипт смотрит включет ли режим автозаполнения и если да,
то он получает html-объект по которому был произведён click. После этого он для каждого выражения xpath в бд находит связанный с ним элемент на текущей странице и сравнивает его с элементом,
по которому кликали. Если совпадает, то берёт значение из value и вставляет его в input.value. Если значение имеет шаблон. то соответственно сначала генерирует строку по этому шаблону. Всё просто.
